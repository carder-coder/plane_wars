# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²é—®é¢˜è¯Šæ–­ä¸è§£å†³æ–¹æ¡ˆ

## ğŸš¨ å½“å‰é—®é¢˜è¯Šæ–­

æ ¹æ®PM2æ—¥å¿—æ˜¾ç¤ºçš„é”™è¯¯ä¿¡æ¯ï¼š
```
Error: Cannot find package 'express' imported from /opt/airplane-battle/dist/server.js
```

### é—®é¢˜åŸå› åˆ†æ

1. **ä¾èµ–ç¼ºå¤±**ï¼šç”Ÿäº§ç¯å¢ƒçš„`node_modules`ç›®å½•ä¸­ç¼ºå°‘å…³é”®ä¾èµ–åŒ…
2. **package.jsonä¸ä¸€è‡´**ï¼šå¯èƒ½ä½¿ç”¨äº†è¿‡æ—¶çš„package.jsoné…ç½®
3. **å®‰è£…è¿‡ç¨‹å¤±è´¥**ï¼šä¹‹å‰çš„ä¾èµ–å®‰è£…å¯èƒ½æ²¡æœ‰å®Œå…¨æˆåŠŸ

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šç´§æ€¥ä¿®å¤ï¼ˆæ¨èï¼‰

åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œç´§æ€¥ä¿®å¤è„šæœ¬ï¼š

```bash
cd /opt/airplane-battle
chmod +x emergency-fix.sh
./emergency-fix.sh
```

è¯¥è„šæœ¬ä¼šï¼š
- åœæ­¢å½“å‰PM2è¿›ç¨‹
- æ¸…ç†æ—§çš„node_moduleså’Œpackage-lock.json
- é‡æ–°å®‰è£…æ‰€æœ‰ç”Ÿäº§ä¾èµ–
- éªŒè¯å…³é”®æ¨¡å—
- æµ‹è¯•åº”ç”¨å¯åŠ¨
- é‡å¯PM2æœåŠ¡

### æ–¹æ¡ˆ2ï¼šæ‰‹åŠ¨ä¿®å¤

å¦‚æœè‡ªåŠ¨è„šæœ¬å¤±è´¥ï¼Œå¯ä»¥æ‰‹åŠ¨æ‰§è¡Œï¼š

```bash
# 1. åœæ­¢æœåŠ¡
pm2 stop airplane-battle-server
pm2 delete airplane-battle-server

# 2. æ¸…ç†ä¾èµ–
rm -rf node_modules package-lock.json

# 3. é‡æ–°å®‰è£…
npm install --omit=dev

# 4. éªŒè¯ä¾èµ–
npm list express mongoose socket.io

# 5. é‡å¯æœåŠ¡
pm2 start ecosystem.config.cjs --env production
```

### æ–¹æ¡ˆ3ï¼šé‡æ–°éƒ¨ç½²

å¦‚æœä»¥ä¸Šæ–¹æ¡ˆéƒ½å¤±è´¥ï¼Œè¿›è¡Œå®Œæ•´é‡æ–°éƒ¨ç½²ï¼š

```bash
# 1. å¤‡ä»½å½“å‰é…ç½®
cp .env .env.backup

# 2. é‡æ–°ä¸Šä¼ éƒ¨ç½²åŒ…
# åœ¨Windowsç¯å¢ƒæ‰§è¡Œ: build-and-deploy.bat

# 3. åœ¨æœåŠ¡å™¨æ‰§è¡Œ
cd /opt/airplane-battle
tar -xzf airplane-battle-deploy.tar.gz
chmod +x deploy-check.sh emergency-fix.sh
./deploy-check.sh
```

## ğŸ“‹ éªŒè¯æ­¥éª¤

ä¿®å¤å®Œæˆåï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤éªŒè¯ï¼š

```bash
# æ£€æŸ¥PM2çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs airplane-battle-server

# æµ‹è¯•æœåŠ¡å“åº”
curl http://localhost:3001/health

# æ£€æŸ¥ä¾èµ–
npm list --depth=0
```

## ğŸ” é¢„æœŸç»“æœ

ä¿®å¤æˆåŠŸåï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```
# PM2çŠ¶æ€
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id  â”‚ name                   â”‚ mode     â”‚ â†º    â”‚ status    â”‚ cpu      â”‚ memory   â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0   â”‚ airplane-battle-server â”‚ cluster  â”‚ 0    â”‚ online    â”‚ 0%       â”‚ XX.X mb  â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

# åº”ç”¨æ—¥å¿—
[INFO] ä½¿ç”¨MongoDBä½œä¸ºæ•°æ®åº“
[INFO] MongoDBè¿æ¥æˆåŠŸ
[INFO] MongoDBåˆå§‹åŒ–å®Œæˆ
[INFO] æœåŠ¡å™¨å·²å¯åŠ¨ - http://localhost:3001
```

## ğŸš€ é¢„é˜²æªæ–½

ä¸ºé¿å…æœªæ¥å‡ºç°ç±»ä¼¼é—®é¢˜ï¼š

1. **ä½¿ç”¨é”å®šæ–‡ä»¶**ï¼šç¡®ä¿package-lock.jsonè¢«æ­£ç¡®éƒ¨ç½²
2. **ä¾èµ–éªŒè¯**ï¼šéƒ¨ç½²å‰éªŒè¯æ‰€æœ‰å…³é”®ä¾èµ–
3. **æ¸è¿›éƒ¨ç½²**ï¼šå…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯å†éƒ¨ç½²åˆ°ç”Ÿäº§
4. **ç›‘æ§å‘Šè­¦**ï¼šè®¾ç½®æœåŠ¡å¥åº·æ£€æŸ¥å’Œå‘Šè­¦

## ğŸ“ è”ç³»æ”¯æŒ

å¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š
- PM2æ—¥å¿—ï¼š`pm2 logs`
- ä¾èµ–åˆ—è¡¨ï¼š`npm list --depth=0`
- Node.jsç‰ˆæœ¬ï¼š`node -v`
- ç¯å¢ƒå˜é‡ï¼šæ£€æŸ¥.envæ–‡ä»¶é…ç½®

---

*æœ€åæ›´æ–°ï¼š2025-09-29*